<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU/CPU 极限压力测试 | Экстремальный стресс-тест</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: monospace; }
        #ui {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            color: #0f0;
            font-size: 11px;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border: 1px solid #0f0;
            width: 280px;
        }
        #ui h1 { font-size: 13px; margin-bottom: 8px; color: #ff0; }
        .ctrl { margin: 6px 0; }
        .ctrl label { display: block; margin-bottom: 2px; }
        .ctrl input[type="range"] { width: 100%; }
        .ctrl span { float: right; color: #0ff; }
        #stats { 
            position: fixed; 
            top: 10px; 
            right: 10px; 
            color: #f00; 
            font-size: 13px;
            background: rgba(0,0,0,0.9);
            padding: 12px;
            border: 1px solid #f00;
            z-index: 1000;
        }
        #stats div { margin: 4px 0; }
        canvas { display: block; }
        #warning {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #f00;
            font-size: 11px;
            background: rgba(0,0,0,0.9);
            padding: 8px 16px;
            border: 1px solid #f00;
            z-index: 1000;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h1>⚠ 极端压力测试 / ЭКСТРЕМАЛЬНЫЙ ТЕСТ ⚠</h1>
        <div class="ctrl">
            <label>粒子数 / Частицы: <span id="pVal">3000000</span></label>
            <input type="range" id="particles" min="1000000" max="10000000" value="3000000" step="500000">
        </div>
        <div class="ctrl">
            <label>光线步数 / Шаги луча: <span id="rVal">512</span></label>
            <input type="range" id="raymarch" min="256" max="2048" value="512" step="128">
        </div>
        <div class="ctrl">
            <label>分形深度 / Глубина фрактала: <span id="fVal">24</span></label>
            <input type="range" id="fractal" min="12" max="48" value="24" step="4">
        </div>
        <div class="ctrl">
            <label>后处理层 / Слои постобр: <span id="lVal">32</span></label>
            <input type="range" id="layers" min="8" max="128" value="32" step="8">
        </div>
        <div class="ctrl">
            <label>物理迭代 / Физика: <span id="phVal">64</span></label>
            <input type="range" id="physics" min="16" max="256" value="64" step="16">
        </div>
        <div class="ctrl">
            <label>超采样 / Суперсэмпл: <span id="ssVal">4</span></label>
            <input type="range" id="supersample" min="1" max="8" value="4" step="1">
        </div>
    </div>
    
    <div id="stats">
        <div>帧率/FPS: <span id="fps">0</span></div>
        <div>帧时间/Кадр: <span id="frametime">0</span>мс</div>
        <div>GPU负载估计/Нагрузка: <span id="gpuload">0</span>%</div>
        <div>活动粒子/Частиц: <span id="activeP">0</span></div>
        <div>着色器操作/Шейдер: <span id="shaderOps">0</span></div>
    </div>
    
    <div id="warning">⚠ 警告：可能导致系统崩溃或过热 / ВНИМАНИЕ: Может вызвать сбой или перегрев ⚠</div>
    
    <canvas id="c"></canvas>
    
    <script>
        const canvas = document.getElementById('c');
        const gl = canvas.getContext('webgl2', { antialias: false, powerPreference: 'high-performance', preserveDrawingBuffer: true });
        if (!gl) { alert('需要WebGL2 / Требуется WebGL2'); throw new Error('No WebGL2'); }
        gl.getExtension('EXT_color_buffer_float');
        gl.getExtension('OES_texture_float_linear');
        
        let W, H;
        const resize = () => { W = window.innerWidth; H = window.innerHeight; canvas.width = W; canvas.height = H; gl.viewport(0, 0, W, H); initFBO(); };
        window.addEventListener('resize', resize);
        
        let params = { particles: 3000000, raymarchSteps: 512, fractalIter: 24, layers: 32, physicsIter: 64, supersample: 4 };
        
        document.getElementById('particles').oninput = e => { params.particles = +e.target.value; document.getElementById('pVal').textContent = params.particles; initParticles(); };
        document.getElementById('raymarch').oninput = e => { params.raymarchSteps = +e.target.value; document.getElementById('rVal').textContent = params.raymarchSteps; };
        document.getElementById('fractal').oninput = e => { params.fractalIter = +e.target.value; document.getElementById('fVal').textContent = params.fractalIter; };
        document.getElementById('layers').oninput = e => { params.layers = +e.target.value; document.getElementById('lVal').textContent = params.layers; };
        document.getElementById('physics').oninput = e => { params.physicsIter = +e.target.value; document.getElementById('phVal').textContent = params.physicsIter; };
        document.getElementById('supersample').oninput = e => { params.supersample = +e.target.value; document.getElementById('ssVal').textContent = params.supersample; };

        const vsMain = `#version 300 es
        precision highp float;
        in vec4 aP; in vec4 aV; in vec4 aC; in vec4 aD;
        uniform mat4 uProj, uView, uModel; uniform float uT, uSz;
        out vec4 vC; out vec3 vP; out vec4 vD; out float vDp;
        
        mat4 r4(float a,float b,float c,float d,float e,float f){
            float ca=cos(a),sa=sin(a),cb=cos(b),sb=sin(b),cc=cos(c),sc=sin(c),cd=cos(d),sd=sin(d),ce=cos(e),se=sin(e),cf=cos(f),sf=sin(f);
            return mat4(ca,-sa,0,0,sa,ca,0,0,0,0,cb,-sb,0,0,sb,cb)*mat4(cc,0,-sc,0,0,cd,0,-sd,sc,0,cc,0,0,sd,0,cd)*mat4(ce,0,0,-se,0,cf,-sf,0,0,sf,cf,0,se,0,0,ce);
        }
        float h5(vec4 p,float t){vec4 q=fract(p*vec4(123.34,234.45,345.56,456.67));q+=dot(q,q.wzxy+t);return fract((q.x+q.y)*(q.z+q.w));}
        
        void main(){
            mat4 r=r4(uT*.7,uT*.5,uT*.3,uT*.4,uT*.6,uT*.8);
            vec4 p4=r*aP;
            float w=2./(4.-p4.w);
            vec3 p3=p4.xyz*w;
            float n=h5(aP,uT);
            p3+=sin(p3.yzx*3.+uT)*.3*n+cos(p3.zxy*5.-uT*1.3)*.2*(1.-n);
            vec3 fp=p3; float sc=1.;
            for(int i=0;i<8;i++){fp=abs(fp)-vec3(1.5,1.2,1.8);fp=fp.yzx;float a=uT*.1+float(i)*.5;fp.xy=mat2(cos(a),-sin(a),sin(a),cos(a))*fp.xy;sc*=.7;}
            p3+=fp*sc*.5;
            vec4 wp=uModel*vec4(p3,1.),vp=uView*wp;
            gl_Position=uProj*vp;
            vDp=-vp.z;
            gl_PointSize=clamp(uSz*w*(500./max(vDp,.1)),1.,64.);
            float h=fract(aD.x+uT*.1+p4.w*.5+n*.3),s=.7+.3*sin(uT+aD.y*6.28),v=.8+.2*cos(uT*1.3+aD.z*6.28);
            vec3 rgb=clamp(abs(mod(h*6.+vec3(0,4,2),6.)-3.)-1.,0.,1.);rgb=rgb*rgb*(3.-2.*rgb);
            vC=vec4(mix(vec3(1),rgb,s)*v,aC.a*w);
            vP=wp.xyz; vD=aD;
        }`;

        const fsMain = `#version 300 es
        precision highp float;
        in vec4 vC; in vec3 vP; in vec4 vD; in float vDp;
        uniform float uT; uniform int uRM,uFI; uniform vec2 uRes;
        out vec4 fC;
        
        float h(vec3 p){p=fract(p*vec3(443.8975,397.2973,491.1871));p+=dot(p.zxy,p.yxz+19.19);return fract(p.x*p.y*p.z);}
        float n3(vec3 p){vec3 i=floor(p),f=fract(p);f=f*f*(3.-2.*f);return mix(mix(mix(h(i),h(i+vec3(1,0,0)),f.x),mix(h(i+vec3(0,1,0)),h(i+vec3(1,1,0)),f.x),f.y),mix(mix(h(i+vec3(0,0,1)),h(i+vec3(1,0,1)),f.x),mix(h(i+vec3(0,1,1)),h(i+vec3(1,1,1)),f.x),f.y),f.z);}
        float fbm(vec3 p,int o){float v=0.,a=.5,f=1.;for(int i=0;i<12;i++){if(i>=o)break;v+=a*n3(p*f);f*=2.17;a*=.49;p=p.yzx+vec3(float(i)*1.13);}return v;}
        
        float mb(vec3 pos,int it){vec3 z=pos;float dr=1.,r=0.,pw=8.+sin(uT*.3)*2.;for(int i=0;i<48;i++){if(i>=it)break;r=length(z);if(r>4.)break;float th=acos(z.z/r),ph=atan(z.y,z.x);dr=pow(r,pw-1.)*pw*dr+1.;float zr=pow(r,pw);th*=pw;ph*=pw;z=zr*vec3(sin(th)*cos(ph),sin(th)*sin(ph),cos(th))+pos;}return .5*log(r)*r/dr;}
        float mg(vec3 p,int it){float d=max(max(abs(p.x),abs(p.y)),abs(p.z))-1.,s=1.;for(int i=0;i<12;i++){if(i>=it)break;vec3 a=mod(p*s,2.)-1.;s*=3.;vec3 r=abs(1.-3.*abs(a));float c=(min(max(r.x,r.y),min(max(r.y,r.z),max(r.z,r.x)))-1.)/s;d=max(d,c);}return d;}
        
        float sdf(vec3 p){float t=uT*.2;mat3 rot=mat3(cos(t),0,sin(t),0,1,0,-sin(t),0,cos(t));vec3 rp=rot*p;float m=mb(rp*.5,uFI),g=mg(rp*.3,uFI/2),n=fbm(p+uT*.1,8)*.3;float gy=sin(rp.x*4.)*cos(rp.y*4.)+sin(rp.y*4.)*cos(rp.z*4.)+sin(rp.z*4.)*cos(rp.x*4.);gy=abs(gy)-.3;return min(min(m,g*2.),gy*.5)+n*.1;}
        
        vec4 rm(vec3 ro,vec3 rd){float t=0.;vec3 col=vec3(0);float al=0.;for(int i=0;i<2048;i++){if(i>=uRM)break;vec3 p=ro+rd*t;float d=sdf(p);if(d<.001){vec2 e=vec2(.001,0);vec3 n=normalize(vec3(sdf(p+e.xyy)-sdf(p-e.xyy),sdf(p+e.yxy)-sdf(p-e.yxy),sdf(p+e.yyx)-sdf(p-e.yyx)));float h=fract(length(p)*.1+uT*.1+dot(n,vec3(1))*.3);vec3 rgb=.5+.5*cos(6.28*(h+vec3(0,.33,.67)));vec3 lt=normalize(vec3(sin(uT),1,cos(uT)));float df=max(dot(n,lt),0.),sp=pow(max(dot(reflect(-lt,n),-rd),0.),32.),ao=1.-float(i)/float(uRM)*.5;col=rgb*(.2+df*.6+sp*.4)*ao;al=1.;break;}if(d<.5){float dn=(.5-d)*.1;float h2=fract(t*.02+uT*.05);vec3 vc=.5+.5*cos(6.28*(h2+vec3(0,.33,.67)));col+=vc*dn*(1.-al);al+=dn*(1.-al);}t+=max(d*.5,.001);if(t>20.||al>.99)break;}return vec4(col,al);}
        
        void main(){vec2 uv=gl_PointCoord*2.-1.;float d=length(uv);if(d>1.)discard;vec3 col=vC.rgb;float al=vC.a*(1.-d*d);vec3 ro=vP,rd=normalize(vP-vec3(0,0,-10));rd.xy+=uv*.1;rd=normalize(rd);vec4 rc=rm(ro*.1,rd);col=mix(col,rc.rgb,rc.a*.5);float ab=.02*d;col.r=mix(col.r,vC.r*1.2,ab);col.b=mix(col.b,vC.b*1.2,ab);col+=vC.rgb*exp(-d*3.)*.5;col*=1./(1.+vDp*.05);fC=vec4(col,al);}`;

        const vsPost = `#version 300 es
        in vec2 aP;out vec2 vU;void main(){vU=aP*.5+.5;gl_Position=vec4(aP,0,1);}`;

        const fsPost = `#version 300 es
        precision highp float;
        in vec2 vU;uniform sampler2D uTx;uniform float uT;uniform int uL,uSS;uniform vec2 uRes;out vec4 fC;
        float h(vec2 p){return fract(sin(dot(p,vec2(127.1,311.7)))*43758.5453);}
        void main(){vec3 col=vec3(0);float tot=0.;for(int sy=0;sy<8;sy++){if(sy>=uSS)break;for(int sx=0;sx<8;sx++){if(sx>=uSS)break;vec2 off=(vec2(float(sx),float(sy))-float(uSS)*.5)/uRes;for(int l=0;l<128;l++){if(l>=uL)break;float t=float(l)/float(uL);vec2 uv=vU+off,dir=(uv-.5)*t*.02;float ca=t*.005;col.r+=texture(uTx,uv+dir+vec2(ca,0)).r;col.g+=texture(uTx,uv+dir).g;col.b+=texture(uTx,uv+dir-vec2(ca,0)).b;tot+=1.;}}}col/=tot;col=col/(col+.5);col=pow(col,vec3(.9));col+=h(vU+uT)*.03-.015;col*=1.-length(vU-.5)*.5;col*=.95+.05*sin(vU.y*uRes.y*2.);fC=vec4(col,1);}`;

        function compS(s,t){const sh=gl.createShader(t);gl.shaderSource(sh,s);gl.compileShader(sh);if(!gl.getShaderParameter(sh,gl.COMPILE_STATUS)){console.error(gl.getShaderInfoLog(sh));return null;}return sh;}
        function mkProg(vs,fs,at){const p=gl.createProgram();gl.attachShader(p,compS(vs,gl.VERTEX_SHADER));gl.attachShader(p,compS(fs,gl.FRAGMENT_SHADER));at.forEach((a,i)=>gl.bindAttribLocation(p,i,a));gl.linkProgram(p);return p;}
        
        const mainP=mkProg(vsMain,fsMain,['aP','aV','aC','aD']);
        const postP=mkProg(vsPost,fsPost,['aP']);
        
        const uProj=gl.getUniformLocation(mainP,'uProj'),uView=gl.getUniformLocation(mainP,'uView'),uModel=gl.getUniformLocation(mainP,'uModel'),uT=gl.getUniformLocation(mainP,'uT'),uSz=gl.getUniformLocation(mainP,'uSz'),uRM=gl.getUniformLocation(mainP,'uRM'),uFI=gl.getUniformLocation(mainP,'uFI'),uRes=gl.getUniformLocation(mainP,'uRes');
        const puTx=gl.getUniformLocation(postP,'uTx'),puT=gl.getUniformLocation(postP,'uT'),puL=gl.getUniformLocation(postP,'uL'),puSS=gl.getUniformLocation(postP,'uSS'),puRes=gl.getUniformLocation(postP,'uRes');
        
        let pPos,pVel,pCol,pDat,posBuf,velBuf,colBuf,datBuf,vao;
        
        function initParticles(){
            const N=params.particles;
            pPos=new Float32Array(N*4);pVel=new Float32Array(N*4);pCol=new Float32Array(N*4);pDat=new Float32Array(N*4);
            for(let i=0;i<N;i++){
                const idx=i*4,th=Math.random()*Math.PI*2,ph=Math.acos(2*Math.random()-1),ps=Math.random()*Math.PI*2,r=Math.pow(Math.random(),.33)*5;
                pPos[idx]=r*Math.sin(ph)*Math.cos(th);pPos[idx+1]=r*Math.sin(ph)*Math.sin(th);pPos[idx+2]=r*Math.cos(ph);pPos[idx+3]=r*Math.sin(ps)*(Math.random()-.5)*2;
                pVel[idx]=(Math.random()-.5)*.1;pVel[idx+1]=(Math.random()-.5)*.1;pVel[idx+2]=(Math.random()-.5)*.1;pVel[idx+3]=(Math.random()-.5)*.1;
                pCol[idx]=Math.random();pCol[idx+1]=Math.random();pCol[idx+2]=Math.random();pCol[idx+3]=.3+Math.random()*.7;
                pDat[idx]=Math.random();pDat[idx+1]=Math.random();pDat[idx+2]=Math.random();pDat[idx+3]=Math.random();
            }
            if(vao)gl.deleteVertexArray(vao);if(posBuf)gl.deleteBuffer(posBuf);if(velBuf)gl.deleteBuffer(velBuf);if(colBuf)gl.deleteBuffer(colBuf);if(datBuf)gl.deleteBuffer(datBuf);
            vao=gl.createVertexArray();gl.bindVertexArray(vao);
            posBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,posBuf);gl.bufferData(gl.ARRAY_BUFFER,pPos,gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,4,gl.FLOAT,false,0,0);
            velBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,velBuf);gl.bufferData(gl.ARRAY_BUFFER,pVel,gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(1);gl.vertexAttribPointer(1,4,gl.FLOAT,false,0,0);
            colBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,colBuf);gl.bufferData(gl.ARRAY_BUFFER,pCol,gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(2);gl.vertexAttribPointer(2,4,gl.FLOAT,false,0,0);
            datBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,datBuf);gl.bufferData(gl.ARRAY_BUFFER,pDat,gl.DYNAMIC_DRAW);gl.enableVertexAttribArray(3);gl.vertexAttribPointer(3,4,gl.FLOAT,false,0,0);
            gl.bindVertexArray(null);
        }
        
        let fbo,fboTex;
        function initFBO(){
            if(fbo)gl.deleteFramebuffer(fbo);if(fboTex)gl.deleteTexture(fboTex);
            fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,fbo);
            fboTex=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,fboTex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA16F,W,H,0,gl.RGBA,gl.FLOAT,null);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
            gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,fboTex,0);gl.bindFramebuffer(gl.FRAMEBUFFER,null);
        }
        
        const qVao=gl.createVertexArray();gl.bindVertexArray(qVao);const qBuf=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,qBuf);gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);gl.enableVertexAttribArray(0);gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);gl.bindVertexArray(null);
        
        function persp(fov,asp,n,f){const t=1/Math.tan(fov/2);return new Float32Array([t/asp,0,0,0,0,t,0,0,0,0,(f+n)/(n-f),-1,0,0,2*f*n/(n-f),0]);}
        function lookAt(e,t,u){const z=norm([e[0]-t[0],e[1]-t[1],e[2]-t[2]]),x=norm(cross(u,z)),y=cross(z,x);return new Float32Array([x[0],y[0],z[0],0,x[1],y[1],z[1],0,x[2],y[2],z[2],0,-dot(x,e),-dot(y,e),-dot(z,e),1]);}
        function rotY(a){const c=Math.cos(a),s=Math.sin(a);return new Float32Array([c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1]);}
        function norm(v){const l=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]);return[v[0]/l,v[1]/l,v[2]/l];}
        function cross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]];}
        function dot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2];}
        
        function updatePhysics(dt,t){
            const N=params.particles,it=params.physicsIter;
            for(let j=0;j<it;j++){
                const sdt=dt/it;
                for(let i=0;i<N;i++){
                    const idx=i*4;
                    let x=pPos[idx],y=pPos[idx+1],z=pPos[idx+2],w=pPos[idx+3],vx=pVel[idx],vy=pVel[idx+1],vz=pVel[idx+2],vw=pVel[idx+3];
                    const r=Math.sqrt(x*x+y*y+z*z+w*w)+.001,r3=r*r*r,gv=-2/r3;
                    let ax=x*gv,ay=y*gv,az=z*gv,aw=w*gv;
                    const rt=.5;ax+=-y*rt;ay+=x*rt;az+=-w*rt*.5;aw+=z*rt*.5;
                    const tb=.3;ax+=Math.sin(y*3+t)*tb;ay+=Math.sin(z*3+t*1.1)*tb;az+=Math.sin(w*3+t*1.2)*tb;aw+=Math.sin(x*3+t*1.3)*tb;
                    const sg=10,rh=28,bt=8/3;ax+=(sg*(y-x))*.01;ay+=(x*(rh-z)-y)*.01;az+=(x*y-bt*z)*.01;
                    vx+=ax*sdt;vy+=ay*sdt;vz+=az*sdt;vw+=aw*sdt;
                    const dp=.999;vx*=dp;vy*=dp;vz*=dp;vw*=dp;
                    x+=vx*sdt;y+=vy*sdt;z+=vz*sdt;w+=vw*sdt;
                    const bd=10;
                    if(Math.abs(x)>bd){x=Math.sign(x)*bd;vx*=-.5;}if(Math.abs(y)>bd){y=Math.sign(y)*bd;vy*=-.5;}if(Math.abs(z)>bd){z=Math.sign(z)*bd;vz*=-.5;}if(Math.abs(w)>bd){w=Math.sign(w)*bd;vw*=-.5;}
                    pPos[idx]=x;pPos[idx+1]=y;pPos[idx+2]=z;pPos[idx+3]=w;pVel[idx]=vx;pVel[idx+1]=vy;pVel[idx+2]=vz;pVel[idx+3]=vw;
                    pDat[idx]=(pDat[idx]+sdt*.1)%1;
                }
            }
            gl.bindBuffer(gl.ARRAY_BUFFER,posBuf);gl.bufferSubData(gl.ARRAY_BUFFER,0,pPos);gl.bindBuffer(gl.ARRAY_BUFFER,velBuf);gl.bufferSubData(gl.ARRAY_BUFFER,0,pVel);gl.bindBuffer(gl.ARRAY_BUFFER,datBuf);gl.bufferSubData(gl.ARRAY_BUFFER,0,pDat);
        }
        
        let lastT=performance.now(),fCnt=0,fps=0,ft=0;
        function updateStats(dt){fCnt++;if(performance.now()-lastT>1000){fps=fCnt;fCnt=0;lastT=performance.now();}ft=dt.toFixed(1);document.getElementById('fps').textContent=fps;document.getElementById('frametime').textContent=ft;document.getElementById('gpuload').textContent=Math.min(100,Math.round(dt/16.67*100));document.getElementById('activeP').textContent=params.particles.toLocaleString();document.getElementById('shaderOps').textContent=(params.particles*params.raymarchSteps*params.layers).toLocaleString();}
        
        resize();initParticles();
        
        let prevT=0;
        function render(time){
            const t=time*.001,dt=time-prevT;prevT=time;
            updateStats(dt);updatePhysics(Math.min(dt*.001,.033),t);
            gl.bindFramebuffer(gl.FRAMEBUFFER,fbo);gl.viewport(0,0,W,H);gl.clearColor(0,0,0,1);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);gl.enable(gl.BLEND);gl.blendFunc(gl.SRC_ALPHA,gl.ONE);gl.enable(gl.DEPTH_TEST);gl.depthMask(false);
            gl.useProgram(mainP);
            const proj=persp(Math.PI/3,W/H,.1,100),cd=15,eye=[Math.sin(t*.2)*cd,Math.sin(t*.15)*5,Math.cos(t*.2)*cd],view=lookAt(eye,[0,0,0],[0,1,0]),model=rotY(t*.1);
            gl.uniformMatrix4fv(uProj,false,proj);gl.uniformMatrix4fv(uView,false,view);gl.uniformMatrix4fv(uModel,false,model);gl.uniform1f(uT,t);gl.uniform1f(uSz,3);gl.uniform1i(uRM,params.raymarchSteps);gl.uniform1i(uFI,params.fractalIter);gl.uniform2f(uRes,W,H);
            gl.bindVertexArray(vao);gl.drawArrays(gl.POINTS,0,params.particles);
            gl.bindFramebuffer(gl.FRAMEBUFFER,null);gl.viewport(0,0,W,H);gl.disable(gl.DEPTH_TEST);gl.disable(gl.BLEND);
            gl.useProgram(postP);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,fboTex);gl.uniform1i(puTx,0);gl.uniform1f(puT,t);gl.uniform1i(puL,params.layers);gl.uniform1i(puSS,params.supersample);gl.uniform2f(puRes,W,H);
            gl.bindVertexArray(qVao);gl.drawArrays(gl.TRIANGLE_STRIP,0,4);
            requestAnimationFrame(render);
        }
        requestAnimationFrame(render);
    </script>
</body>
</html>
